<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verified</title>
    <link rel="stylesheet" href="signup.css">
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>Email Verification</h1>
            
            <div id="message" class="message">
                <p>Verifying your email and setting up your account...</p>
            </div>
            
            <div id="loadingSpinner" style="text-align: center; margin: 20px 0;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>

    <style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .message {
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        text-align: center;
    }
    .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .hidden { display: none; }
    </style>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // Supabase Configuration
    const SUPABASE_URL = "https://dhbmtcnuxishkaycskea.supabase.co";
   const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoYm10Y251eGlzaGtheWNza2VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDA3MDAsImV4cCI6MjA3NDQxNjcwMH0.L_BwZNz4BW8GqSyOuJzaKkUkZoRq-7Uz3y5SUha05bM";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const messageDiv = document.getElementById('message');
    const loadingSpinner = document.getElementById('loadingSpinner');

          // Generate referral code function
    function generateReferralCode(username) {
        const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `${username.toLowerCase().slice(0, 4)}${randomNum}`;
    }

    // Show message function
    function showMessage(text, type = 'success') {
        messageDiv.innerHTML = `<p>${text}</p>`;
        messageDiv.className = `message ${type}`;
        loadingSpinner.classList.add('hidden');
    }

    // Create user profile after email verification
// Create user profile after email verification
async function createUserProfile(user) {
    try {
        // Get user metadata stored during signup
        const full_name = user.user_metadata.full_name || '';
        const username = user.user_metadata.username || 'user';
        const referralCode = user.user_metadata.referral_code || null;

        // Generate personal referral code
        const myReferralCode = generateReferralCode(username);

        // Check if profile already exists (prevent duplicates)
        const { data: existingProfile } = await supabase
            .from('profiles')
            .select('id')
            .eq('id', user.id)
            .single();

        if (existingProfile) {
            showMessage('Account already set up! Redirecting to dashboard...', 'success');
            setTimeout(() => window.location.href = 'dashboard.html', 2000);
            return;
        }

        let validReferralCode = null;

        // Validate referral code if provided
        if (referralCode) {
            const { data: referrerData, error: referrerError } = await supabase
                .from('profiles')
                .select('id')
                .eq('referral_code', referralCode)
                .single();

            if (!referrerError && referrerData) {
                validReferralCode = referralCode;
            }
        }

        // âœ… Step 1: Insert profile first
        const { error: profileError } = await supabase
            .from('profiles')
            .upsert([{
                id: user.id,
                full_name: full_name,
                username: username,
                email: user.email,
                referral_code: myReferralCode,
                referred_by: validReferralCode
            }], { onConflict: 'id' });

        if (profileError) {
            console.error('Profile creation error:', profileError);
            throw new Error('Failed to create user profile');
        }

        // âœ… Step 2: Create wallet only after profile is confirmed
        const { error: walletError } = await supabase
            .from('wallets')
            .insert([{ user_id: user.id }]);

        if (walletError) {
            console.error('Wallet creation error:', walletError);
            // Donâ€™t throw â€” wallet can be added later
        }

        // âœ… Step 3: Handle referral strictly via RPC
        if (referralCode) {
            const { data: referralHandled, error } = await supabase.rpc("process_referral", {
                referred_user_id_param: user.id,
                referral_code_param: referralCode
            });

            if (error || !referralHandled) {
                console.error("Referral handling failed:", error);
                showMessage("Referral setup failed. Please try again or contact support.", "error");
                return; // ðŸš« Halt signup flow here
            }

            console.log("Referral processed successfully âœ…");
        }

        // âœ… Success
        showMessage('Account verified and set up successfully! Redirecting to dashboard...', 'success');
        setTimeout(() => window.location.href = 'dashboard.html', 2000);

    } catch (error) {
        console.error('Profile setup error:', error);
        showMessage('Account verified but profile setup failed. Please contact support.', 'error');
    }
}

    // Handle email verification
    async function handleEmailVerification() {
        try {
            // Check for auth tokens in URL (from email verification link)
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');

            if (accessToken && refreshToken) {
                // Set session with tokens from email verification
                const { data, error } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });

                if (error) {
                    throw new Error('Failed to verify email: ' + error.message);
                }

                if (data.user && data.user.email_confirmed_at) {
                    // Email verified successfully, create profile
                    await createUserProfile(data.user);
                } else {
                    throw new Error('Email verification incomplete');
                }
            } else {
                // No tokens in URL, check current session
                const { data: { user }, error } = await supabase.auth.getUser();

                if (error) {
                    throw new Error('Failed to get user session');
                }

                if (user && user.email_confirmed_at) {
                    // User is verified, create profile
                    await createUserProfile(user);
                } else {
                    throw new Error('Email not verified or user not found');
                }
            }

        } catch (error) {
            console.error('Email verification error:', error);
            showMessage(`Verification failed: ${error.message}. Please try signing up again or contact support.`, 'error');
        }
    }

    // Start verification process on page load
    document.addEventListener('DOMContentLoaded', handleEmailVerification);
    </script>
</body>
</html>