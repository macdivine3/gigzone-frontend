<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GigZone | Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
/>
<!-- Modal CSS -->
<style>
  #notif-modal {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  align-items: center; justify-content: center;
  z-index: 1000;

  /* hide by default */
  display: none;
}

#notif-modal.show {
  display: flex;
}
  .modal-content {
    background: #fff; border-radius: 8px;
    padding: 20px; max-width: 400px; width: 90%;
    max-height: 80%; overflow-y: auto; position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .modal-close {
    position: absolute; top: 10px; right: 15px;
    font-size: 18px; cursor: pointer;
  }
  .notif-item { padding: 8px 0; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<!-- Sidebar -->
  <div class="menu-toggle">&#9776;</div>
  <aside class="sidebar">
    <h2>GigZone</h2>
    <ul>
      <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
      <li><a href="browse.html"><i class="fas fa-search"></i>Browse Tasks</a></li>
      <li><a href="mytasks.html"><i class="fas fa-tasks"></i>My Tasks</a></li>
      <li><a href="earnings.html"><i class="fas fa-dollar-sign"></i>Earnings</a></li>
      <li><a href="wallet.html"><i class="fas fa-wallet"></i>Wallet</a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i>Profile</a></li>
      <li><a href="referrals.html"><i class="fas fa-users"></i>Referrals</a></li>
      <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i>Log Out</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content">

    <!-- Welcome Header -->
    <header>
      <h1 id="welcome-message">Welcome back 👋</h1>
      <p>Here's what's going on today.</p>
    </header>

    <!-- Topbar Icons -->
    <div class="topbar">
      <!-- Badge Bar -->
<div id="badge-bar" class="badge-bar" role="button">
  <span id="badge-icon" class="badge-icon"></span>
  <span id="badge-text" class="badge-text"></span>
</div>

<!-- Tooltip (hidden by default) -->
<div id="badge-tooltip" class="badge-tooltip hidden">
  💡 Click your badge to track progress & unlock rewards!
</div>

<!-- Badge Modal -->
<div id="badge-modal" class="modal hidden">
  <div class="modal-content">
    <button id="badge-modal-close" class="modal-close">&times;</button>
    <h2>Your Badge & Progress</h2>
    <div id="modal-current-badge" class="current-badge"></div>
    <div id="modal-progress-bars" class="progress-bars"></div>
  </div>
</div>

      <div class="icons">
       <div class="notification-wrapper" style="position: relative;">
  <i id="notif-bell" class="fas fa-bell"></i>
  <span id="notif-dot" style="
    display:none;
    background:red;
    border-radius:50%;
    width:10px; height:10px;
    position:absolute; top:0; right:0;"></span>
</div>
        <i class="fas fa-envelope"></i>
        <i class="fas fa-user-circle"></i>
      </div>
    </div>
    

    <!-- Verification Banner -->
    <div class="verify-banner">
      <h3>Get Verified to Unlock Full Access</h3>
      <p>✨ Verified users enjoy no withdrawal limits, ₦700 per referral, and bonus rewards.</p>
      <a href="wallet.html" class="get-verified-btn">
        <button class="verify-btn">Get Verified for ₦1200</button>
      </a>
    </div>

    <!-- Stats Cards -->
<section class="stats">
  <a href="earnings.html" class="card-link">
    <div class="card">
      <h3 id="total-earnings">₦0.00</h3>
      <p>Total Earnings</p>
    </div>
  </a>

  <a href="earnings.html" class="card-link">
    <div class="card">
      <h3 id="withdrawable_balance">₦0.00</h3>
      <p>Withdrawable Balance</p>
    </div>
  </a>

  <a href="browse.html" class="card-link">
    <div class="card">
      <h3 id="completed-tasks">0</h3>
      <p>Completed Tasks</p>
    </div>
  </a>
</section>

    <!-- Tasks Preview -->
    <section class="task-feed">
      <h2>Available Gigs</h2>
      <div class="task-card">
        <h3>Follow on Instagram</h3>
        <p>Follow a brand page and take a screenshot.</p>
        <span class="pay">₦300</span>
        <a href="browse.html">
         <button>Apply</button>
        </a>
      </div>
      <div class="task-card">
        <h3>Download an App</h3>
        <p>Download and use a specific app for 5 minutes.</p>
        <span class="pay">₦500</span>
        <a href="browse.html">
         <button>Apply</button>
        </a>
      </div>
      <a href="browse.html" class="view-more">View All Tasks →</a>
    </section>
  </div>
  <!-- Notifications Modal -->
<div id="notif-modal" class="hidden">
  <div class="modal-content">
    <span id="notif-close" class="modal-close">&times;</span>
    <h2>Notifications</h2>
    <div id="notif-modal-list">
      <!-- injected by JS -->
    </div>
  </div>
</div>

  <!-- UI Scripts -->
  <script>
    // Sidebar toggle
    document.querySelector('.menu-toggle').addEventListener('click', () => {
      document.querySelector('.sidebar').classList.toggle('open');
    });

    // Notification red dot
    const redDot = document.getElementById('notif-dot');
    redDot.style.display = 'block';
    document.querySelector('.notification-wrapper').addEventListener('click', () => {
      redDot.style.display = 'none';
    });

    // Parallax on scroll
    window.addEventListener('scroll', () => {
      const scrolled = window.pageYOffset;
      document.querySelector('header').style.transform = `translateY(${scrolled * 0.5}px)`;
    });

    // Card hover animations
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('mouseenter', () => card.style.transform = 'translateY(-8px) scale(1.02)');
      card.addEventListener('mouseleave', () => card.style.transform = 'translateY(0) scale(1)');
    });
  </script>

  <!-- Supabase Auth & Data Script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const { createClient } = window.supabase;

  const supabaseClient = createClient(
  "https://dhbmtcnuxishkaycskea.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoYm10Y251eGlzaGtheWNza2VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDA3MDAsImV4cCI6MjA3NDQxNjcwMH0.L_BwZNz4BW8GqSyOuJzaKkUkZoRq-7Uz3y5SUha05bM"
  );
  // Show loading overlay
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.innerHTML = '<p>Loading…</p>';
  document.body.appendChild(overlay);

  (async () => {
    // 🔒 Check if session exists
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

    if (sessionError || !session) {
      alert('You are not logged in. Redirecting to login.');
      window.location.href = 'login.html';
      return;
    }

    // ✅ Session exists, now get user
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser();

    if (userError || !user) {
      alert('Authentication failed, redirecting to login');
      window.location.href = 'login.html';
      return;
    }

    // 🧑 Fetch username from profiles
    const { data: profileData, error: profileError } = await supabaseClient
      .from("profiles")
      .select("username")
      .eq("id", user.id)
      .single();

    if (profileError || !profileData) {
      console.error("Profile fetch error:", profileError);
      return;
    }

    // 👋 Show welcome message
    document.getElementById("welcome-message").textContent = `Welcome back, ${profileData.username} 👋`;
    await fetchAndDisplayStats();
    document.body.removeChild(overlay);
  })();

  // 🚪 Logout
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('logout-link').addEventListener('click', async e => {
      e.preventDefault();
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    });
  });

  // 🔁 Auth state change listener
  supabaseClient.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') window.location.href = 'login.html';
  });

  // 🔗 Verify button link
  document.querySelector(".verify-btn").addEventListener("click", () => {
    window.location.href = 'verify.html';
  });

  // dynamically fetch dashboard cards
  async function fetchAndDisplayStats() {
    // Step 1: Get current user
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !user) {
      console.error("User not logged in", userError);
      return;
    }

    const userId = user.id;

    try {
      // Step 2: Fetch total earnings
      const { data: transactions, error: txnErr } = await supabaseClient
        .from('transactions')
        .select('amount')
        .eq('user_id', userId)
        .in('type', ['task_reward', 'referral_bonus']);

      const totalFromTransactions = txnErr ? 0 : transactions.reduce((sum, t) => sum + Number(t.amount), 0);

      const { data: badges, error: badgeErr } = await supabaseClient
        .from('badge_rewards')
        .select('amount')
        .eq('user_id', userId);

      const totalFromBadges = badgeErr ? 0 : badges.reduce((sum, b) => sum + Number(b.amount), 0);

      const totalEarnings = totalFromTransactions + totalFromBadges;
      document.getElementById('total-earnings').textContent = `₦${totalEarnings.toFixed(2)}`;

      // Step 3: Fetch withdrawable balance
      const { data: wallet, error: walletErr } = await supabaseClient
        .from('wallets')
        .select('withdrawable_balance')
        .eq('user_id', userId)
        .single();

      const withdrawable_balance = walletErr || !wallet ? 0 : Number(wallet.withdrawable_balance);
      document.getElementById('withdrawable_balance').textContent = `₦${withdrawable_balance.toFixed(2)}`;

      // Step 4: Fetch completed task count
      const { count: completedCount, error: countErr } = await supabaseClient
        .from('task_submissions')
        .select('*', { count: 'exact', head: true })
        .eq('freelancer_id', userId)
        .eq('status', 'approved');

      const tasksCompleted = countErr ? 0 : completedCount;
      document.getElementById('completed-tasks').textContent = tasksCompleted;

    } catch (err) {
      console.error("Error fetching stats:", err);
    }
  }
</script>
<!-- Supabase + Notifications JS -->
<script src="/js/notifications.js" defer></script>
<!--Badges js-->
<script src="/js/badges.js" defer></script>
</body>
</html>