<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile - GigZone</title>
  <link rel="stylesheet" href="profile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body>

<!-- Sidebar -->
<div class="menu-toggle">&#9776;</div>
<aside class="sidebar">
  <h2>GigZone</h2>
  <ul>
    <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
    <li><a href="browse.html"><i class="fas fa-search"></i>Browse Tasks</a></li>
    <li><a href="mytasks.html"><i class="fas fa-tasks"></i>My Tasks</a></li>
    <li><a href="earnings.html"><i class="fas fa-dollar-sign"></i>Earnings</a></li>
    <li><a href="wallet.html"><i class="fas fa-wallet"></i>Wallet</a></li>
    <li><a href="profile.html" class="active"><i class="fas fa-user"></i>Profile</a></li>
    <li><a href="referrals.html"><i class="fas fa-users"></i>Referrals</a></li>
    <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i>Log Out</a></li>
  </ul>
</aside>

<div class="main-content">
  <header>
    <h1>Profile Settings</h1>
    <p>Manage your personal information</p>
  </header>

  <div class="profile-card">
    <div class="form-group">
      <label for="avatar">Avatar</label>
      <div class="avatar-container">
        <img id="avatar-preview" src="assets/images/default-avatar.png" alt="Avatar" />
        <div class="upload-section">
          <input type="file" id="avatar-input" accept="image/*" />
          <button id="upload-avatar-btn">Upload</button>
        </div>
      </div>
    </div>

    <div class="profile-right">
      <form class="profile-form" id="profile-form">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" readonly />
        </div>

        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="full-name" placeholder="John Doe" />
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" readonly />
        </div>

        <div class="form-group">
          <label>Bank Name</label>
          <input type="text" id="bank-name" readonly />
        </div>

        <div class="form-group">
          <label>Account Number</label>
          <input type="text" id="account-number" readonly />
        </div>

        <div class="profile-actions">
          <button type="submit">Save Changes</button>
        </div>
      </form>

      <div class="referral-section">
        <p style="cursor: pointer; color: #007BFF; text-decoration: underline;" id="go-to-referral">
          Want to refer friends? ðŸ‘‰ Click here to view your referral link
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://fwwbsoesxijhhpzpdjou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3d2Jzb2VzeGlqaGhwenBkam91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NzA0MzEsImV4cCI6MjA2ODE0NjQzMX0.qELrGVrVdug3q53cxNGStsFEfLcb7N-lVS9u3qu6HEE'
  );
  const bankMap = {
  "044": "Access Bank",
  "050": "Ecobank Nigeria",
  "070": "Fidelity Bank",
  "011": "First Bank of Nigeria",
  "214": "First City Monument Bank (FCMB)",
  "058": "Guaranty Trust Bank (GTBank)",
  "030": "Heritage Bank",
  "301": "Jaiz Bank",
  "082": "Keystone Bank",
  "221": "Stanbic IBTC Bank",
  "068": "Standard Chartered Bank",
  "232": "Sterling Bank",
  "032": "Union Bank of Nigeria",
  "033": "United Bank for Africa (UBA)",
  "215": "Unity Bank",
  "035": "Wema Bank",
  "057": "Zenith Bank",
  "076": "Polaris Bank",
  "100": "SunTrust Bank"
};
  // On page load, check auth state and fetch profile
  document.addEventListener('DOMContentLoaded', async () => {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) return (window.location.href = 'login.html');

    const userId = session.user.id;

    // Get Profile Data
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (profileError) {
      console.error('Profile fetch error:', profileError);
      return;
    }

    document.getElementById('username').value = profile.username || '';
    document.getElementById('full-name').value = profile.full_name || '';
    document.getElementById('email').value = profile.email || session.user.email;
    document.getElementById('avatar-preview').src = profile.avatar_url || 'assets/images/default-avatar.png';

    // Get Wallet Data
    const { data: wallet, error: walletError } = await supabaseClient
      .from('wallets')
      .select('bank_name, account_number')
      .eq('user_id', userId)
      .single();

    const bankInput = document.getElementById('bank-name');
    const accountInput = document.getElementById('account-number');

    if (wallet && wallet.bank_name && wallet.account_number) {
  const bankCode = wallet.bank_name; // stored as code in DB
  bankInput.value = bankMap[bankCode] || bankCode; // show real name or fallback
  accountInput.value = wallet.account_number;

    } else {
      bankInput.value = 'Not linked yet';
      accountInput.value = 'Not linked yet';
      const redirect = () => window.location.href = 'link-bank.html';
      bankInput.addEventListener('click', redirect);
      accountInput.addEventListener('click', redirect);
    }

    // Referral CTA
    document.getElementById('go-to-referral').addEventListener('click', () => {
      window.location.href = 'referrals.html';
    });
  });

  // Upload Avatar
  document.getElementById('upload-avatar-btn').addEventListener('click', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('avatar-input');
    const file = fileInput.files[0];
    if (!file) return alert('Please select a file first.');

    const { data: { session } } = await supabaseClient.auth.getSession();
    const userId = session?.user?.id;
    if (!userId) return (window.location.href = 'login.html');

    const fileExt = file.name.split('.').pop();
    const filePath = `avatars/${userId}_${Date.now()}.${fileExt}`;

    const { error: uploadError } = await supabaseClient
      .storage
      .from('avatars')
      .upload(filePath, file, { cacheControl: '3600', upsert: true });

    if (uploadError) {
      console.error(uploadError);
      return alert('Upload failed.');
    }

    const { data: { publicUrl } } = supabaseClient
      .storage
      .from('avatars')
      .getPublicUrl(filePath);

    const { error: updateError } = await supabaseClient
      .from('profiles')
      .update({ avatar_url: publicUrl })
      .eq('id', userId);

    if (updateError) {
      console.error(updateError);
      return alert('Failed to update avatar.');
    }

    document.getElementById('avatar-preview').src = publicUrl;
    alert('Avatar updated successfully!');
  });

  // Save Full Name
  document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fullName = document.getElementById('full-name').value;

    const { data: { session } } = await supabaseClient.auth.getSession();
    const userId = session?.user?.id;
    if (!userId) return (window.location.href = 'login.html');

    const { error } = await supabaseClient
      .from('profiles')
      .update({ full_name: fullName })
      .eq('id', userId);

    if (error) {
      console.error(error);
      return alert('Failed to update name.');
    }

    alert('Profile updated!');
  });

  // Logout
  document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    await supabaseClient.auth.signOut();
    window.location.href = 'login.html';
  });

  // Sidebar toggle
  const menuToggle = document.querySelector('.menu-toggle');
  const sidebar = document.querySelector('.sidebar');
  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });
</script>
</body>
</html>
